name: üöÄ Test and deploy

on:
  push:
    branches:
      - main

jobs:
  test:
    name: üß™ Test
    runs-on: ubuntu-latest
    steps:
      - name: üìù Checkout
        uses: actions/checkout@v3
      - name: üü¢ Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 18
          registry-url: https://registry.npmjs.org
      - name: üì¶ Install dependencies
        uses: bahmutov/npm-install@v1
      - name: üß™ Run tests
        run: npm run test

  release:
    name: üöÄ Deploy
    runs-on: ubuntu-latest
    steps:
      - name: üìù Checkout
        uses: actions/checkout@v3
      - name: üü¢ Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 18
          registry-url: https://registry.npmjs.org
      - name: üì¶ Install dependencies
        uses: bahmutov/npm-install@v1
      - name: üóû Get new release version
        run: npx semantic-release@17 --dry-run --no-ci
      - name: Assign release version from to env variable
        run: cat .VERSION >> $GITHUB_ENV
      - name: üèó Build app
        run: npm run build
        env:
          REACT_APP_VERSION: $VERSION
          REACT_APP_AUTHOR_NAME: ${{secrets.AUTHOR_NAME}}
          REACT_APP_AUTHOR_EMAIL: ${{secrets.AUTHOR_EMAIL}}
          REACT_APP_PROJECT_REPO_URL: ${{github.repository}}
          REACT_APP_BING_MAPS_API_KEY: ${{secrets.BING_MAPS_API_KEY}}
      - name: Deploy üöÄ
        uses: JamesIves/github-pages-deploy-action@v4.3.3
        with:
          branch: gh-pages
          folder: build